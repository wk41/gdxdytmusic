<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乐团谱务管理系统 (稳定版)</title>
    
    <!-- 1. 引入 Tailwind CSS (样式库) - 使用 Staticfile 源 -->
    <script src="https://cdn.staticfile.org/tailwindcss/3.4.1/browser.js"></script>

    <!-- 2. 图标库 (Lucide) - 修复：改用 jsDelivr UMD 版本，并增加容错 -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.363.0/dist/umd/lucide.min.js" 
            onerror="this.src='https://unpkg.com/lucide@latest/dist/umd/lucide.min.js'"></script>

    <style>
        /* 基础样式 */
        body { font-family: sans-serif; background-color: #f8fafc; }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #fileInput { display: none; }

        /* 加载中提示 */
        #loading-screen {
            position: fixed; inset: 0; background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            color: #64748b; font-size: 14px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased min-h-screen pb-20">

    <!-- 加载遮罩 -->
    <div id="loading-screen">
        <div style="width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;"></div>
        <p>系统资源加载中...</p>
        <p style="font-size: 12px; color: #94a3b8; margin-top: 5px;" id="loading-text">(正在连接图标库...)</p>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <!-- 顶部导航 -->
    <header class="sticky top-0 z-30 glass-panel border-b border-slate-200 px-4 py-3 shadow-sm">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-indigo-200 shadow-md">
                    <i data-lucide="database" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-none">乐团谱务系统</h1>
                    <p class="text-[10px] text-slate-500 mt-1 font-mono">Stable Ver 3.2</p>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1">
                <div id="statusBadge"></div>
                <label class="text-xs text-indigo-600 cursor-pointer hover:underline flex items-center gap-1">
                    <i data-lucide="upload" class="w-3 h-3"></i> 导入CSV
                    <input type="file" id="fileInput" accept=".csv">
                </label>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        
        <!-- 搜索与过滤 -->
        <div class="space-y-4">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </div>
                <input type="text" id="searchInput" 
                    class="block w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-sm"
                    placeholder="搜索曲名、作曲家、编号或标签...">
            </div>

            <div class="flex flex-wrap gap-2" id="filterContainer">
                <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all border bg-white text-slate-600 border-slate-200 hover:bg-slate-50" data-filter="hasPdf">
                    <i data-lucide="file-text" class="w-3 h-3 mr-1.5"></i> PDF电子版
                </button>
                <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all border bg-white text-slate-600 border-slate-200 hover:bg-slate-50" data-filter="hasSib">
                    <i data-lucide="music" class="w-3 h-3 mr-1.5"></i> Sibelius
                </button>
                <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all border bg-white text-slate-600 border-slate-200 hover:bg-slate-50" data-filter="hasFinale">
                    <i data-lucide="music" class="w-3 h-3 mr-1.5"></i> Finale
                </button>
                <span class="ml-auto text-xs text-slate-400 self-center" id="countText">加载中...</span>
            </div>
        </div>

        <!-- 列表区域 -->
        <div id="listContainer" class="space-y-3 min-h-[50vh]">
            <!-- 内容由 JS 生成 -->
        </div>

        <!-- 底部信息 -->
        <div class="text-center text-[10px] text-slate-400 pb-4">
             <p id="lastUpdateText"></p>
             <p class="mt-1">Powered by Vanilla JS & Tailwind</p>
        </div>
    </main>

    <!-- JS 逻辑 -->
    <script>
        // --- 配置 ---
        const CSV_FILENAME = 'database.csv';
        const DEMO_DATA = [
            { id: 101, title: "演示-春节序曲", composer: "李焕之", arranger: "", inventoryId: "CO-Demo01", location: "A1-1", scoreType: "总谱 分谱", hasPdf: true, hasSib: true, tags: "节日,喜庆,返场", remarks: "请连接 Gitee/GitHub 或手动导入 database.csv 以加载真实数据" },
            { id: 102, title: "演示-瑶族舞曲", composer: "刘铁山", arranger: "彭修文", inventoryId: "CO-Demo02", location: "B2-3", scoreType: "总谱", hasPdf: false, hasSib: false, tags: "经典", remarks: "这是本地演示数据" }
        ];

        // --- 状态 ---
        let state = {
            data: [],
            filters: { hasPdf: false, hasSib: false, hasFinale: false },
            expandedId: null,
            status: 'init'
        };

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 检查 Lucide 是否加载
            let checkInterval = setInterval(() => {
                if (window.lucide) {
                    clearInterval(checkInterval);
                    lucide.createIcons();
                    // 隐藏加载画面
                    document.getElementById('loading-screen').style.display = 'none';
                } else {
                    document.getElementById('loading-text').innerText = "正在尝试备用线路...";
                }
            }, 100);

            // 3秒后强制移除加载画面，防止卡死
            setTimeout(() => {
                clearInterval(checkInterval);
                document.getElementById('loading-screen').style.display = 'none';
                if (!window.lucide) console.warn("图标库加载超时，图标可能无法显示");
            }, 3000);

            initData();
            
            // 绑定事件
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.addEventListener('input', renderList);
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.addEventListener('change', handleImport);
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterType = e.currentTarget.dataset.filter;
                    state.filters[filterType] = !state.filters[filterType];
                    updateFilterUI();
                    renderList();
                });
            });
        });

        async function initData() {
            renderLoading();
            
            // 1. 读取本地缓存
            const cached = localStorage.getItem('musicLibData_v3');
            const time = localStorage.getItem('musicLibTime_v3');
            
            if (cached) {
                try {
                    state.data = JSON.parse(cached);
                    updateStatus('offline');
                    if(time) document.getElementById('lastUpdateText').innerText = "数据更新于: " + time;
                    renderList();
                    if(window.lucide) lucide.createIcons();
                } catch(e) {}
            }

            // 2. 尝试网络同步
            try {
                if (window.location.protocol === 'file:') {
                    console.warn("本地文件模式运行，跳过网络请求");
                    throw new Error("LocalPreview");
                }
                
                const res = await fetch(`./${CSV_FILENAME}?t=${Date.now()}`);
                if (!res.ok) throw new Error("NetworkFail");
                
                const text = await res.text();
                const parsed = parseCSV(text);
                
                if (parsed.length > 0) {
                    state.data = parsed;
                    const now = new Date().toLocaleString();
                    localStorage.setItem('musicLibData_v3', JSON.stringify(parsed));
                    localStorage.setItem('musicLibTime_v3', now);
                    document.getElementById('lastUpdateText').innerText = "数据更新于: " + now;
                    updateStatus('success');
                    renderList();
                }
            } catch (err) {
                console.warn("同步失败:", err);
                if (state.data.length === 0) {
                    state.data = DEMO_DATA;
                    updateStatus('demo');
                    renderList();
                }
            }
        }

        // --- 核心逻辑 ---
        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                let row = [];
                let inQuote = false;
                let current = '';
                for(let char of lines[i]) {
                    if(char === '"') { inQuote = !inQuote; continue; }
                    if(char === ',' && !inQuote) { row.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                row.push(current.trim());
                
                if (row.length < 5) continue;
                
                result.push({
                    id: i,
                    title: row[1] || "未命名",
                    form: row[2] || "",
                    composer: row[3] || "",
                    arranger: row[4] || row[5] || "",
                    inventoryId: row[6] || "",
                    location: row[7] || "",
                    scoreType: row[8] || "",
                    hasPdf: checkBool(row[9]),
                    hasSib: checkBool(row[10]),
                    hasFinale: checkBool(row[11]),
                    remarks: row[16] || "",
                    tags: row[17] || ""
                });
            }
            return result;
        }

        function checkBool(str) {
            return str && (str.includes('✓') || str.toLowerCase().includes('ok') || str.trim().length > 0);
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const parsed = parseCSV(evt.target.result);
                if(parsed.length > 0) {
                    state.data = parsed;
                    const now = new Date().toLocaleString() + " (手动)";
                    localStorage.setItem('musicLibData_v3', JSON.stringify(parsed));
                    localStorage.setItem('musicLibTime_v3', now);
                    document.getElementById('lastUpdateText').innerText = "数据更新于: " + now;
                    updateStatus('manual');
                    renderList();
                    alert(`成功导入 ${parsed.length} 条数据`);
                } else {
                    alert("解析失败，请检查格式");
                }
            };
            reader.readAsText(file);
        }

        // --- UI 渲染 ---
        function updateFilterUI() {
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(btn => {
                const type = btn.dataset.filter;
                if (state.filters[type]) {
                    btn.className = 'filter-btn flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all border cursor-pointer bg-emerald-50 text-emerald-700 border-emerald-200 shadow-sm';
                } else {
                    btn.className = 'filter-btn flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all border cursor-pointer bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
                }
            });
        }

        function updateStatus(status) {
            state.status = status;
            const el = document.getElementById('statusBadge');
            let html = '';
            if (status === 'success') html = `<span class="flex items-center text-emerald-600 text-xs bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100"><span class="w-2 h-2 rounded-full bg-emerald-500 mr-1.5"></span>已同步云端</span>`;
            else if (status === 'demo') html = `<span class="flex items-center text-amber-600 text-xs bg-amber-50 px-2 py-1 rounded-full border border-amber-100"><span class="w-2 h-2 rounded-full bg-amber-500 mr-1.5"></span>演示模式</span>`;
            else if (status === 'manual') html = `<span class="flex items-center text-blue-600 text-xs bg-blue-50 px-2 py-1 rounded-full border border-blue-100"><span class="w-2 h-2 rounded-full bg-blue-500 mr-1.5"></span>手动导入</span>`;
            else html = `<span class="flex items-center text-slate-400 text-xs bg-slate-100 px-2 py-1 rounded-full"><span class="w-2 h-2 rounded-full bg-slate-400 mr-1.5"></span>离线模式</span>`;
            el.innerHTML = html;
        }

        function renderLoading() {
            document.getElementById('listContainer').innerHTML = `
                <div class="text-center py-10 text-slate-400">
                    <div class="inline-block w-6 h-6 border-2 border-slate-300 border-t-indigo-600 rounded-full animate-spin mb-2"></div>
                    <p class="text-xs">正在读取数据库...</p>
                </div>`;
        }

        function renderList() {
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = state.data.filter(item => {
                const content = `${item.title} ${item.composer} ${item.arranger} ${item.inventoryId} ${item.tags}`.toLowerCase();
                const matchSearch = content.includes(searchVal);
                const matchPdf = state.filters.hasPdf ? item.hasPdf : true;
                const matchSib = state.filters.hasSib ? item.hasSib : true;
                const matchFinale = state.filters.hasFinale ? item.hasFinale : true;
                return matchSearch && matchPdf && matchSib && matchFinale;
            });

            document.getElementById('countText').innerText = `共 ${filtered.length} 条`;

            const container = document.getElementById('listContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-200">
                        <p class="text-slate-400 text-sm">没有找到相关乐谱</p>
                    </div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isExpanded = state.expandedId === item.id;
                const idPrefix = item.inventoryId.split('-')[1]?.substring(0,2) || '..';
                
                let tagsHtml = '';
                if (item.tags) {
                    tagsHtml = item.tags.split(/,|，/).map(tag => 
                        `<span class="flex items-center px-1.5 py-0.5 rounded text-[10px] bg-slate-200 text-slate-600 mr-1 mb-1"><i data-lucide="tag" class="w-3 h-3 mr-1 opacity-50"></i>${tag.trim()}</span>`
                    ).join('');
                }

                let remarksHtml = '';
                if (item.remarks) {
                    remarksHtml = `<div class="flex items-start gap-2 text-xs text-amber-700 bg-amber-50 p-2 rounded border border-amber-100 mt-2"><i data-lucide="alert-circle" class="w-3 h-3 mt-0.5 shrink-0"></i><span>${item.remarks}</span></div>`;
                }

                const detailSection = isExpanded ? `
                    <div class="bg-slate-50 border-t border-slate-100 px-4 py-4 fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2 sm:col-span-1 space-y-3">
                                <div>
                                    <div class="text-xs font-semibold text-slate-400 uppercase mb-1">库存位置</div>
                                    <div class="flex items-center gap-2 bg-white p-2 rounded border border-slate-200 shadow-sm">
                                        <i data-lucide="folder" class="text-indigo-500 w-4 h-4"></i>
                                        <span class="font-mono font-bold text-lg text-slate-700">${item.location || "未记录"}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-slate-400 uppercase mb-1">库存编号</div>
                                    <div class="font-mono text-sm text-slate-700 select-all">${item.inventoryId}</div>
                                </div>
                            </div>
                            <div class="col-span-2 sm:col-span-1 space-y-2">
                                <div class="text-xs font-semibold text-slate-400 uppercase mb-1">档案状态</div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="p-1.5 rounded text-xs border ${item.hasPdf ? 'bg-emerald-100 border-emerald-200 text-emerald-800 font-bold' : 'bg-slate-100 border-slate-200 text-slate-400'}">PDF</div>
                                    <div class="p-1.5 rounded text-xs border ${item.hasSib ? 'bg-purple-100 border-purple-200 text-purple-800 font-bold' : 'bg-slate-100 border-slate-200 text-slate-400'}">Sib</div>
                                    <div class="p-1.5 rounded text-xs border ${item.hasFinale ? 'bg-blue-100 border-blue-200 text-blue-800 font-bold' : 'bg-slate-100 border-slate-200 text-slate-400'}">Fin</div>
                                </div>
                                <div class="flex justify-between text-xs pt-1 border-t border-slate-200 mt-2">
                                    <span class="text-slate-500">谱种:</span>
                                    <span class="font-medium">${item.scoreType || "-"}</span>
                                </div>
                            </div>
                            <div class="col-span-2 pt-2 border-t border-slate-200 mt-1">
                                <div class="flex flex-wrap">${tagsHtml}</div>
                                ${remarksHtml}
                            </div>
                        </div>
                    </div>
                ` : '';

                return `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-200 transition-all duration-200 overflow-hidden cursor-pointer" onclick="toggleExpand(${item.id})">
                        <div class="p-4 flex gap-4 items-start relative">
                            <div class="absolute left-0 top-0 bottom-0 w-1 ${item.hasPdf ? 'bg-emerald-500' : 'bg-slate-200'}"></div>
                            <div class="flex-shrink-0 pt-0.5">
                                <div class="w-12 h-12 rounded-lg bg-slate-100 text-slate-600 flex flex-col items-center justify-center border border-slate-200">
                                    <span class="text-[10px] font-mono text-slate-400 uppercase">No.</span>
                                    <span class="text-sm font-bold font-mono">${idPrefix}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-900 text-lg truncate pr-2">${item.title}</h3>
                                    <span class="text-slate-300">
                                        <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-5 h-5"></i>
                                    </span>
                                </div>
                                <div class="text-sm text-slate-600 mt-0.5 flex items-center gap-2">
                                    <span>${item.composer || "未知作曲"}</span>
                                    ${item.arranger ? `<span class="text-slate-400 text-xs px-1 border-l border-slate-300">编: ${item.arranger}</span>` : ''}
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    ${item.form ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border bg-slate-100 text-slate-600 border-slate-200">${item.form}</span>` : ''}
                                    ${item.hasPdf ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border bg-emerald-50 text-emerald-700 border-emerald-100"><i data-lucide="file-text" class="w-3 h-3 mr-1"></i>PDF</span>` : ''}
                                    ${item.hasSib ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border bg-purple-50 text-purple-700 border-purple-100"><i data-lucide="music" class="w-3 h-3 mr-1"></i>Sib</span>` : ''}
                                </div>
                            </div>
                        </div>
                        ${detailSection}
                    </div>
                `;
            }).join('');
            
            if (window.lucide) lucide.createIcons();
        }

        window.toggleExpand = function(id) {
            state.expandedId = state.expandedId === id ? null : id;
            renderList();
        }
    </script>
</body>
</html>
