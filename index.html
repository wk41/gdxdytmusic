<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乐团谱务管理系统V5.0</title>
    
    <!-- 移除所有外部脚本依赖，改用原生 CSS -->
    <style>
        /* --- 基础重置 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; color: #334155; padding-bottom: 80px; }
        input, button { font-family: inherit; }

        /* --- 布局工具 --- */
        .container { max-width: 800px; margin: 0 auto; padding: 0 16px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .hidden { display: none; }
        .mt-2 { margin-top: 8px; }

        /* --- 顶部导航 --- */
        header { 
            position: sticky; top: 0; z-index: 100; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid #e2e8f0; 
            padding: 12px 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-icon { 
            background: #4f46e5; color: white; 
            width: 36px; height: 36px; 
            border-radius: 8px; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }
        .brand-text h1 { margin: 0; font-size: 18px; font-weight: 700; color: #1e293b; line-height: 1.2; }
        .brand-text p { margin: 0; font-size: 11px; color: #64748b; font-family: monospace; }

        /* --- 导入按钮 --- */
        .import-btn { 
            font-size: 13px; color: #4f46e5; cursor: pointer; 
            display: flex; align-items: center; gap: 4px; 
            padding: 6px 10px; border-radius: 6px;
            transition: background 0.2s;
        }
        .import-btn:hover { background: #eef2ff; }
        #fileInput { display: none; }

        /* --- 搜索与过滤 --- */
        .search-section { margin: 20px 0; }
        .search-wrapper { position: relative; margin-bottom: 12px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-input { 
            width: 100%; padding: 12px 12px 12px 40px; 
            border: 1px solid #cbd5e1; border-radius: 12px; 
            font-size: 14px; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-input:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .filter-tags { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .filter-btn { 
            background: white; border: 1px solid #cbd5e1; color: #64748b; 
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; 
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #f1f5f9; }
        
        /* 激活状态的过滤按钮 */
        .filter-btn.active[data-filter="hasPdf"] { background: #ecfdf5; border-color: #6ee7b7; color: #047857; }
        .filter-btn.active[data-filter="hasSib"] { background: #faf5ff; border-color: #d8b4fe; color: #7e22ce; }
        .filter-btn.active[data-filter="hasFinale"] { background: #eff6ff; border-color: #93c5fd; color: #1d4ed8; }

        .count-text { margin-left: auto; font-size: 12px; color: #94a3b8; }

        /* --- 卡片列表 --- */
        .list-container { display: flex; flex-direction: column; gap: 12px; min-height: 50vh; }
        
        .card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; 
            overflow: hidden; cursor: pointer; transition: all 0.2s;
            position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: #c7d2fe; }
        
        .card-main { padding: 16px; display: flex; gap: 16px; align-items: flex-start; position: relative; }
        
        /* 左侧状态条 */
        .status-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e2e8f0; }
        .status-bar.has-pdf { background: #10b981; } /* 绿色 */

        .inventory-box { 
            flex-shrink: 0; width: 48px; height: 48px; 
            background: #f1f5f9; border-radius: 8px; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #64748b;
        }
        .inv-label { font-size: 10px; text-transform: uppercase; font-family: monospace; }
        .inv-val { font-size: 14px; font-weight: 700; font-family: monospace; color: #334155; }

        .card-content { flex: 1; min-width: 0; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title { font-size: 16px; font-weight: 700; color: #0f172a; margin: 0; line-height: 1.4; }
        .card-meta { font-size: 13px; color: #64748b; margin-top: 4px; display: flex; align-items: center; gap: 8px; }
        .arranger-tag { padding-left: 8px; border-left: 1px solid #cbd5e1; color: #94a3b8; font-size: 12px; }

        .card-badges { display: flex; gap: 6px; margin-top: 8px; align-items: center; }
        .badge { 
            font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 500; 
            border: 1px solid transparent; display: flex; align-items: center; gap: 4px;
        }
        .badge-gray { background: #f1f5f9; color: #475569; border-color: #e2e8f0; }
        .badge-green { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }
        .badge-purple { background: #faf5ff; color: #7e22ce; border-color: #e9d5ff; }

        /* --- 详情展开区 --- */
        .detail-panel { 
            background: #f8fafc; border-top: 1px solid #e2e8f0; 
            padding: 16px; animation: slideDown 0.2s ease-out;
            display: none; /* 预设隐藏 */
        }
        .detail-panel.open { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .detail-group h4 { font-size: 11px; color: #94a3b8; text-transform: uppercase; margin: 0 0 4px 0; font-weight: 600; }
        
        .info-box { background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
        .info-box.loc { color: #4f46e5; font-weight: 700; font-family: monospace; font-size: 16px; }
        .info-box.val { font-size: 13px; color: #334155; font-family: monospace; }

        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .status-item { 
            font-size: 11px; text-align: center; padding: 4px; border-radius: 4px; border: 1px solid #e2e8f0; background: #f1f5f9; color: #94a3b8;
        }
        .status-item.active.pdf { background: #d1fae5; border-color: #6ee7b7; color: #065f46; font-weight: bold; }
        .status-item.active.sib { background: #f3e8ff; border-color: #d8b4fe; color: #6b21a8; font-weight: bold; }
        .status-item.active.fin { background: #dbeafe; border-color: #93c5fd; color: #1e40af; font-weight: bold; }

        .tags-row { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
        .mini-tag { font-size: 10px; background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 4px; }
        
        .remark-box { 
            margin-top: 8px; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; 
            font-size: 12px; padding: 8px; border-radius: 6px; display: flex; gap: 6px; align-items: flex-start;
        }

        /* --- 底部 --- */
        .footer { text-align: center; font-size: 11px; color: #94a3b8; margin-top: 20px; }
        
        /* --- 加载动画 --- */
        #loading-overlay {
            position: fixed; inset: 0; background: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top-color: #4f46e5;
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 状态徽章 --- */
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-right: 8px; }
        .status-badge.offline { background: #f1f5f9; color: #64748b; }
        .status-badge.online { background: #ecfdf5; color: #047857; }
        .status-badge.demo { background: #fffbeb; color: #b45309; }
        .status-badge.manual { background: #eff6ff; color: #1d4ed8; }

    </style>
</head>
<body>

    <!-- 加载画面 -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="color: #64748b; font-size: 14px;">系统资源加载中...</div>
    </div>

    <!-- 顶部 -->
    <header>
        <div class="container header-content">
            <div class="brand">
                <div class="brand-icon">
                    <!-- ICON: Database -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                </div>
                <div class="brand-text">
                    <h1>星之海乐谱查询系统</h1>
                    <p>Ver 5.0 Offline</p>
                </div>
            </div>
            <div style="display:flex; align-items:center;">
                <span id="connStatus"></span>
                <label class="import-btn">
                    <!-- ICON: Upload -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    <span>导入CSV</span>
                    <input type="file" id="fileInput" accept=".csv">
                </label>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- 搜索 -->
        <div class="search-section">
            <div class="search-wrapper">
                <div class="search-icon">
                    <!-- ICON: Search -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                </div>
                <input type="text" id="searchInput" class="search-input" placeholder="搜索曲名、作曲家、编号或标签...">
            </div>
            <div class="filter-tags">
                <button class="filter-btn" data-filter="hasPdf">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    PDF电子版
                </button>
                <button class="filter-btn" data-filter="hasSib">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    Sibelius
                </button>
                <button class="filter-btn" data-filter="hasFinale">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    Finale
                </button>
                <span id="countText" class="count-text">准备就绪</span>
            </div>
        </div>

        <!-- 列表 -->
        <div id="listContainer" class="list-container">
            <!-- 内容由 JS 生成 -->
        </div>

        <!-- 底部 -->
        <div class="footer">
            <p id="lastUpdateText"></p>
            <p>Pure HTML/CSS/JS • No External Dependencies</p>
        </div>
    </main>

    <script>
        // --- 0. 内嵌图标库 (SVG Strings) ---
        // 这样就不需要依赖外部脚本了，绝对稳定
        const Icons = {
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
            chevronUp: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>`,
            folder: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>`,
            tag: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><circle cx="7" cy="7" r="2"/></svg>`,
            alert: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`,
            pdf: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`
        };

        // --- 配置 ---
        const CSV_FILENAME = 'database.csv';
        const DEMO_DATA = [
            { id: 101, title: "演示-春节序曲", composer: "李焕之", arranger: "", inventoryId: "CO-Demo01", location: "A1-1", scoreType: "总谱 分谱", hasPdf: true, hasSib: true, tags: "节日,喜庆,返场", remarks: "这是演示数据。若要查看真实数据，请将 database.csv 与此文件放在同一目录，或点击右上角手动导入。" },
            { id: 102, title: "演示-瑶族舞曲", composer: "刘铁山", arranger: "彭修文", inventoryId: "CO-Demo02", location: "B2-3", scoreType: "总谱", hasPdf: false, hasSib: false, tags: "经典", remarks: "这是本地演示数据" }
        ];

        // --- 状态 ---
        let state = {
            data: [],
            filters: { hasPdf: false, hasSib: false, hasFinale: false },
            expandedId: null
        };

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 延迟一点移除遮罩，确保样式渲染完成
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            }, 300);

            initData();

            // 事件绑定
            document.getElementById('searchInput').addEventListener('input', renderList);
            document.getElementById('fileInput').addEventListener('change', handleImport);
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.filter;
                    state.filters[type] = !state.filters[type];
                    // 切换 active class
                    e.currentTarget.classList.toggle('active');
                    renderList();
                });
            });
        });

        // --- 数据加载逻辑 ---
        async function initData() {
            // 1. 读取本地缓存 (Local Storage)
            const cached = localStorage.getItem('musicLibData_v5');
            const time = localStorage.getItem('musicLibTime_v5');
            
            if (cached) {
                try {
                    state.data = JSON.parse(cached);
                    updateStatus('offline');
                    if(time) setUpdateText(time);
                    renderList();
                } catch(e) {}
            }

            // 2. 尝试网络读取 (Fetch)
            try {
                if (window.location.protocol === 'file:') {
                    console.log("本地模式运行，跳过网络请求");
                    throw new Error("LocalMode");
                }

                const res = await fetch(`./${CSV_FILENAME}?t=${Date.now()}`);
                if (!res.ok) throw new Error("FetchFail");
                
                const text = await res.text();
                const parsed = parseCSV(text);
                
                if (parsed.length > 0) {
                    state.data = parsed;
                    const now = new Date().toLocaleString();
                    localStorage.setItem('musicLibData_v5', JSON.stringify(parsed));
                    localStorage.setItem('musicLibTime_v5', now);
                    setUpdateText(now);
                    updateStatus('online');
                    renderList();
                }
            } catch (err) {
                // 如果没有数据 (也没有缓存)，载入演示数据
                if (state.data.length === 0) {
                    state.data = DEMO_DATA;
                    updateStatus('demo');
                    renderList();
                }
            }
        }

        // --- CSV 解析器 ---
        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            const result = [];
            // i=1 跳过标题
            for (let i = 1; i < lines.length; i++) {
                let row = [];
                let inQuote = false;
                let current = '';
                for(let char of lines[i]) {
                    if(char === '"') { inQuote = !inQuote; continue; }
                    if(char === ',' && !inQuote) { row.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                row.push(current.trim());
                
                if (row.length < 5) continue;
                
                // 映射逻辑 (根据您提供的 CSV 结构)
                // 0:序号 1:名称 2:形式 3:作曲 4:编曲1 5:编曲2 6:库存编号 7:区域 8:谱种 9:PDF 10:Sib 11:Fin 16:备注 17:标签
                result.push({
                    id: i,
                    title: row[1] || "未命名",
                    form: row[2] || "",
                    composer: row[3] || "",
                    arranger: row[4] || row[5] || "",
                    inventoryId: row[6] || "",
                    location: row[7] || "",
                    scoreType: row[8] || "",
                    hasPdf: checkBool(row[9]),
                    hasSib: checkBool(row[10]),
                    hasFinale: checkBool(row[11]),
                    remarks: row[16] || "",
                    tags: row[17] || ""
                });
            }
            return result;
        }

        function checkBool(str) {
            return str && (str.includes('✓') || str.toLowerCase().includes('ok') || str.trim().length > 0);
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const parsed = parseCSV(evt.target.result);
                if(parsed.length > 0) {
                    state.data = parsed;
                    const now = new Date().toLocaleString() + " (手动)";
                    localStorage.setItem('musicLibData_v5', JSON.stringify(parsed));
                    localStorage.setItem('musicLibTime_v5', now);
                    setUpdateText(now);
                    updateStatus('manual');
                    renderList();
                    alert(`成功导入 ${parsed.length} 条数据`);
                } else {
                    alert("解析失败，请检查 CSV 格式");
                }
            };
            reader.readAsText(file);
        }

        // --- 渲染 ---
        function renderList() {
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('listContainer');
            
            const filtered = state.data.filter(item => {
                const content = `${item.title} ${item.composer} ${item.arranger} ${item.inventoryId} ${item.tags}`.toLowerCase();
                const matchSearch = content.includes(searchVal);
                const matchPdf = state.filters.hasPdf ? item.hasPdf : true;
                const matchSib = state.filters.hasSib ? item.hasSib : true;
                const matchFinale = state.filters.hasFinale ? item.hasFinale : true;
                return matchSearch && matchPdf && matchSib && matchFinale;
            });

            document.getElementById('countText').innerText = `共 ${filtered.length} 条`;

            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 40px; color:#94a3b8; font-size:14px;">没有找到相关乐谱</div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isExpanded = state.expandedId === item.id;
                const idShort = item.inventoryId.split('-')[1]?.substring(0,2) || '..';
                
                // 标签 HTML
                let tagsHtml = '';
                if (item.tags) {
                    tagsHtml = item.tags.split(/,|，/).map(t => 
                        `<span class="mini-tag">#${t.trim()}</span>`
                    ).join('');
                }

                // 详情区块 HTML
                const detailHtml = isExpanded ? `
                    <div class="detail-panel open">
                        <div class="detail-grid">
                            <div class="detail-group">
                                <h4>库存位置</h4>
                                <div class="info-box">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4f46e5"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>
                                    <span class="info-box loc">${item.location || "-"}</span>
                                </div>
                                <div style="margin-top:8px;">
                                    <h4>库存编号</h4>
                                    <div class="info-box val select-all">${item.inventoryId}</div>
                                </div>
                            </div>
                            <div class="detail-group">
                                <h4>档案状态</h4>
                                <div class="status-grid">
                                    <div class="status-item ${item.hasPdf ? 'active pdf' : ''}">PDF</div>
                                    <div class="status-item ${item.hasSib ? 'active sib' : ''}">Sib</div>
                                    <div class="status-item ${item.hasFinale ? 'active fin' : ''}">Fin</div>
                                </div>
                                <div style="margin-top:12px; font-size:12px; color:#64748b; display:flex; justify-content:space-between;">
                                    <span>谱种配置:</span>
                                    <span style="font-weight:500; color:#334155;">${item.scoreType || "-"}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${(item.tags || item.remarks) ? `
                            <div class="tags-row">
                                ${tagsHtml}
                                ${item.remarks ? `
                                    <div style="width:100%;" class="remark-box">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                        <span>${item.remarks}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                ` : '';

                return `
                    <div class="card" onclick="toggleExpand(${item.id})">
                        <div class="card-main">
                            <div class="status-bar ${item.hasPdf ? 'has-pdf' : ''}"></div>
                            
                            <div class="inventory-box">
                                <div class="inv-label">No.</div>
                                <div class="inv-val">${idShort}</div>
                            </div>
                            
                            <div class="card-content">
                                <div class="card-header">
                                    <h3 class="card-title">${item.title}</h3>
                                    <div style="color:#cbd5e1;">
                                        ${isExpanded ? 
                                          `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>` : 
                                          `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`
                                        }
                                    </div>
                                </div>
                                
                                <div class="card-meta">
                                    <span>${item.composer || "未知作曲"}</span>
                                    ${item.arranger ? `<span class="arranger-tag">编: ${item.arranger}</span>` : ''}
                                </div>

                                <div class="card-badges">
                                    ${item.form ? `<span class="badge badge-gray">${item.form}</span>` : ''}
                                    ${item.hasPdf ? `<span class="badge badge-green"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>PDF</span>` : ''}
                                    ${item.hasSib ? `<span class="badge badge-purple"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>Sib</span>` : ''}
                                </div>
                            </div>
                        </div>
                        ${detailHtml}
                    </div>
                `;
            }).join('');
        }

        window.toggleExpand = function(id) {
            state.expandedId = state.expandedId === id ? null : id;
            renderList();
        }

        function updateStatus(status) {
            const el = document.getElementById('connStatus');
            let text = '', cls = '';
            if (status === 'online') { text = '已同步'; cls = 'online'; }
            else if (status === 'offline') { text = '离线模式'; cls = 'offline'; }
            else if (status === 'demo') { text = '演示模式'; cls = 'demo'; }
            else if (status === 'manual') { text = '手动导入'; cls = 'manual'; }
            
            el.innerHTML = `<span class="status-badge ${cls}">${text}</span>`;
        }

        function setUpdateText(time) {
            document.getElementById('lastUpdateText').innerText = "数据更新于: " + time;
        }
    </script>
</body>
</html>
